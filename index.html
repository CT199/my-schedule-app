<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹æ’ç¨‹ç³»çµ± (çµ‚æ¥µæ“ä½œé«”é©—ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f8fafc; }
        
        /* æ‹–æ›³ç‰©ä»¶æ¨£å¼ */
        .draggable-source { 
            cursor: grab; 
            transition: all 0.2s; 
            border-left-width: 6px; 
            user-select: none;
            /* æ–°å¢ï¼šä½¿é …ç›®å¯æ‹–æ›³ */
            position: relative; 
        }
        .draggable-source:active { cursor: grabbing; }
        .draggable-source:hover { transform: translateX(4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* æ‹–æ›³æ¸…å–®æ’åºæ™‚çš„é ç•™ç©ºé–“ */
        .drag-over-placeholder {
            height: 10px; /* ä½”ä½é«˜åº¦ */
            background-color: #3b82f6;
            border-radius: 4px;
            margin-bottom: 12px;
            transition: height 0.2s;
        }

        /* ç·¨è¼¯æ¨¡å¼é«˜äº® */
        .editing-mode { border: 2px solid #f59e0b; background-color: #fffbeb; }

        /* é¡è‰²é¸æ“‡å™¨å„ªåŒ– */
        .color-radio:checked + label { ring: 2px; ring-offset: 2px; ring-color: #64748b; transform: scale(1.1); }

        /* åˆ—å°æ™‚çš„æ¨£å¼ */
        @media print {
            .no-print { display: none !important; }
            .print-only-header { display: block !important; text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; }
            #calendar-wrapper { width: 100% !important; height: auto !important; overflow: visible !important; }
            body { background: white; }
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        .print-only-header { display: none; }
        
        /* æ–°å¢ï¼šæ—¥æ›†é‚Šç•ŒæŒ‡ç¤ºï¼Œç”¨æ–¼æ‹–æ›³äº‹ä»¶å›æ¸…å–® */
        #external-events {
            border: 2px dashed transparent;
            transition: border 0.3s;
        }
        .drag-enter-list {
            border: 2px dashed #f97316 !important;
            background-color: #fff7ed !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 overflow-hidden">

    <header class="bg-slate-900 text-white p-3 shadow-lg flex justify-between items-center flex-shrink-0 z-20">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-bold tracking-wide">ğŸš§ å·¥ç¨‹æ’ç¨‹ç®¡ç†ç³»çµ±</h1>
            <span class="text-xs bg-green-600 px-2 py-0.5 rounded text-white opacity-90">v9.0</span>
        </div>
        
        <div class="text-right text-sm">
            <div class="text-slate-400 text-xs flex items-center justify-end gap-2 mb-1">
                <label for="countdown-target-date" class="mr-2">ç›®æ¨™æ—¥:</label>
                <input type="date" id="countdown-target-date" class="bg-slate-700 text-white text-xs px-2 py-1 rounded" onchange="updateCountdown()">
                
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" id="exclude-sun-toggle" checked onclick="updateCountdown()" class="form-checkbox h-3 w-3 text-blue-600 rounded">
                    <span>æ’é™¤é€±æ—¥</span>
                </label>
            </div>
            <div class="font-bold text-yellow-400 text-lg">
                å‰©é¤˜ <span id="countdown-days" class="font-mono text-2xl">0</span> å€‹å·¥ä½œæ—¥
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside class="no-print w-[350px] bg-white border-r border-slate-300 flex flex-col shadow-[4px_0_15px_rgba(0,0,0,0.05)] z-10">
            
            <div id="form-container" class="p-4 bg-slate-50 border-b border-slate-200">
                <div class="flex justify-between items-center mb-3">
                    <h2 id="form-title" class="text-base font-bold text-slate-700 flex items-center gap-2">
                        âœï¸ æ–°å¢æ¡ˆä»¶è³‡æ–™
                    </h2>
                    <button id="cancel-edit-btn" onclick="resetForm()" class="hidden text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded transition">å–æ¶ˆç·¨è¼¯</button>
                </div>

                <input type="hidden" id="input-id"> <div class="mb-3">
                    <label class="block text-xs text-slate-500 mb-1 font-bold">æ¡ˆä»¶åç¨± (å¿…å¡«)</label>
                    <input type="text" id="input-title" placeholder="ä¾‹å¦‚ï¼šæ¾ç«¹è·¯è£ä¿®å·¥ç¨‹" 
                           class="w-full p-2.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none shadow-sm"
                           onkeypress="if(event.key === 'Enter') saveTask()">
                </div>

                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div>
                        <label class="block text-[10px] text-slate-500 mb-1">æ¡ˆä»¶é¡å‹</label>
                        <select id="input-category" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:border-blue-500 outline-none">
                            <option value="å¯å®‰æ’">âœ… å¯å®‰æ’</option>
                            <option value="ç­‰å¾…ç¾å ´">â³ ç­‰å¾…ç¾å ´</option>
                            <option value="äº‹å…ˆæ‹†é™¤">ğŸ”¨ äº‹å…ˆæ‹†é™¤</option>
                            <option value="ç¶­ä¿®ä»¶">ğŸ”§ ç¶­ä¿®ä»¶</option>
                        </select>
                    </div>
                    <div class="flex gap-1">
                        <div class="w-1/2">
                            <label class="block text-[10px] text-slate-500 mb-1">å¤©æ•¸</label>
                            <input type="number" id="input-days" value="1" step="0.5" min="0.5" class="w-full p-2 border border-slate-300 rounded text-center text-sm focus:border-blue-500 outline-none">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-[10px] text-slate-500 mb-1">äººæ•¸</label>
                            <input type="number" id="input-workers" value="2" min="1" class="w-full p-2 border border-slate-300 rounded text-center text-sm focus:border-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <div class="mb-3 p-2 bg-white rounded border border-slate-200">
                    <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-700 font-bold">
                        <input type="checkbox" id="input-skip-sunday" class="form-checkbox h-4 w-4 text-orange-500 rounded border-gray-300">
                        æ’ç¨‹å¤©æ•¸ **è‡ªå‹•è·³éé€±æ—¥**
                    </label>
                    <p class="text-[10px] text-slate-400 mt-1 pl-6">ï¼ˆå‹¾é¸å¾Œï¼Œè¨ˆç®—å·¥ç¨‹ç¸½å¤©æ•¸æ™‚æœƒç•¥éé€±æ—¥ï¼‰</p>
                </div>


                <div class="mb-3">
                    <div class="flex justify-between items-center bg-white p-2 rounded border border-slate-200">
                        <input type="radio" name="color" id="c-blue" value="#3b82f6" class="color-radio hidden" checked>
                        <label for="c-blue" class="w-5 h-5 rounded-full bg-blue-500 cursor-pointer" title="è—è‰²"></label>
                        
                        <input type="radio" name="color" id="c-green" value="#10b981" class="color-radio hidden">
                        <label for="c-green" class="w-5 h-5 rounded-full bg-emerald-500 cursor-pointer" title="ç¶ è‰²"></label>
                        
                        <input type="radio" name="color" id="c-red" value="#ef4444" class="color-radio hidden">
                        <label for="c-red" class="w-5 h-5 rounded-full bg-red-500 cursor-pointer" title="ç´…è‰²"></label>
                        
                        <input type="radio" name="color" id="c-orange" value="#f97316" class="color-radio hidden">
                        <label for="c-orange" class="w-5 h-5 rounded-full bg-orange-500 cursor-pointer" title="æ©˜è‰²"></label>
                        
                        <input type="radio" name="color" id="c-purple" value="#a855f7" class="color-radio hidden">
                        <label for="c-purple" class="w-5 h-5 rounded-full bg-purple-500 cursor-pointer" title="ç´«è‰²"></label>
                        
                        <input type="radio" name="color" id="c-dark" value="#475569" class="color-radio hidden">
                        <label for="c-dark" class="w-5 h-5 rounded-full bg-slate-600 cursor-pointer" title="ç°è‰²"></label>
                    </div>
                </div>

                <div class="mb-3">
                    <textarea id="input-note" placeholder="å‚™è¨»äº‹é … (é¸å¡«)..." class="w-full p-2 border border-slate-300 rounded text-sm h-12 resize-none focus:border-blue-500 outline-none"></textarea>
                </div>

                <button id="submit-btn" onclick="saveTask()" class="w-full bg-slate-800 hover:bg-slate-700 active:bg-slate-900 text-white py-2.5 rounded-lg text-sm font-bold transition shadow-md flex justify-center items-center gap-2">
                    <span>â• åŠ å…¥æ¸…å–®</span>
                </button>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden bg-white">
                <div class="p-3 border-b bg-slate-50 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-slate-600">ğŸ“‹ å¾…æ’ç¨‹æ¸…å–® (å¯æ‹–æ›³æ’åº)</h3>
                    <select id="filter-category" onchange="renderList()" class="text-xs border border-slate-300 rounded px-2 py-1 bg-white text-slate-600">
                        <option value="all">å…¨éƒ¨é¡¯ç¤º</option>
                        <option value="å¯å®‰æ’">âœ… å¯å®‰æ’</option>
                        <option value="ç­‰å¾…ç¾å ´">â³ ç­‰å¾…ç¾å ´</option>
                        <option value="äº‹å…ˆæ‹†é™¤">ğŸ”¨ äº‹å…ˆæ‹†é™¤</option>
                        <option value="ç¶­ä¿®ä»¶">ğŸ”§ ç¶­ä¿®ä»¶</option>
                    </select>
                </div>
                
                <div id="external-events" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-100" 
                    ondragover="handleDragOver(event)" ondrop="handleDropInList(event)" ondragleave="handleDragLeave(event)">
                    </div>
            </div>
            
            <div class="p-2 border-t bg-slate-50 text-center">
                <button onclick="clearAllData()" class="text-xs text-gray-400 hover:text-red-600 transition underline">
                    âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡æ–°é–‹å§‹
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-white relative">
            <div class="print-only-header">å·¥ç¨‹æ’ç¨‹ç¸½è¡¨</div>
            <div class="flex-1 p-4 overflow-auto">
                <div id='calendar' class="h-full min-h-[600px]"></div>
            </div>
        </main>
    </div>

    <script>
        // ==========================================
        // 1. åˆå§‹åŒ–èˆ‡å…¨åŸŸè®Šæ•¸
        // ==========================================
        const STORAGE_KEY = 'schedule_data_v9'; // å‡ç´šç‰ˆæœ¬è™Ÿ
        const DEFAULT_TARGET_DATE_STR = '2026-02-17'; // é è¨­ç›®æ¨™æ—¥æœŸ
        let jobs = []; 
        let calendar;  
        let draggedItem = null; // ç”¨æ–¼æ¸…å–®å…§éƒ¨æ‹–æ›³æ’åº
        let placeholder = null; // ç”¨æ–¼æ¸…å–®å…§éƒ¨æ‹–æ›³æ’åº

        // ç•¶ç¶²é è¼‰å…¥å®Œæˆæ™‚
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // è¼‰å…¥é è¨­/å„²å­˜çš„ç›®æ¨™æ—¥æœŸ
            const storedTargetDate = localStorage.getItem('countdown_target_date') || DEFAULT_TARGET_DATE_STR;
            document.getElementById('countdown-target-date').value = storedTargetDate;

            updateCountdown(); // åŸ·è¡Œå€’æ•¸è¨ˆæ™‚
            initDraggable();    
            initCalendar();    
            renderList();
        });
        
        // ==========================================
        // 2. æ‹–æ›³åŠŸèƒ½åˆå§‹åŒ– (ç¢ºä¿åªåŸ·è¡Œä¸€æ¬¡)
        // ==========================================
        function initDraggable() {
            const containerEl = document.getElementById('external-events');
            
            // FullCalendar Draggable è² è²¬ï¼šæ¸…å–® -> è¡Œäº‹æ›†
            new FullCalendar.Draggable(containerEl, {
                itemSelector: '.draggable-source',
                eventData: function(eventEl) {
                    const id = eventEl.dataset.id;
                    const job = jobs.find(j => j.id === id);
                    
                    if (!job) return {}; 

                    return {
                        id: job.id,
                        title: job.title,
                        allDay: true,
                        backgroundColor: job.color,
                        borderColor: job.color,
                        extendedProps: {
                            workers: job.workers,
                            note: job.note,
                            category: job.category,
                            days: job.days,
                            skipSunday: job.skipSunday
                        }
                    };
                }
            });
        }

        // ==========================================
        // 3. æ¸…å–®å…§æ‹–æ›³æ’åºé‚è¼¯ (æ–°çš„åŠŸèƒ½)
        // ==========================================
        function handleDragStart(event) {
            draggedItem = event.target;
            event.dataTransfer.setData('text/plain', draggedItem.dataset.id);
            event.dataTransfer.effectAllowed = 'move';
            
            // éš±è—æ‹–æ›³ä¸­çš„é …ç›®
            setTimeout(() => {
                draggedItem.style.display = 'none';
            }, 0); 
            
            // å‰µå»ºä½”ä½ç¬¦
            placeholder = document.createElement('div');
            placeholder.className = 'drag-over-placeholder';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const listContainer = document.getElementById('external-events');
            
            // è™•ç†æ¸…å–®å…§æ‹–æ›³æ’åº
            if (draggedItem) {
                const target = event.target.closest('.draggable-source');
                if (target && target !== draggedItem) {
                    const rect = target.getBoundingClientRect();
                    const next = (event.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                    
                    if (!placeholder.parentNode) {
                        target.parentNode.insertBefore(placeholder, target);
                    }
                    
                    if (next) {
                        target.parentNode.insertBefore(placeholder, target.nextSibling);
                    } else {
                        target.parentNode.insertBefore(placeholder, target);
                    }
                } else if (!target) {
                     // å¦‚æœæ‹–åˆ°æ¸…å–®åº•éƒ¨ç©ºç™½è™•ï¼Œå°‡ä½”ä½ç¬¦åŠ åˆ°æœ«å°¾
                    if (listContainer.lastElementChild !== placeholder) {
                        listContainer.appendChild(placeholder);
                    }
                }
            } else {
                // è™•ç†è¡Œäº‹æ›†äº‹ä»¶æ‹–å›æ¸…å–®çš„æ¨£å¼
                listContainer.classList.add('drag-enter-list');
            }
        }
        
        function handleDragLeave(event) {
            const listContainer = document.getElementById('external-events');
            // æ¸…é™¤è¡Œäº‹æ›†æ‹–å›æ¸…å–®çš„æ¨£å¼
            if (event.target === listContainer || !listContainer.contains(event.relatedTarget)) {
                listContainer.classList.remove('drag-enter-list');
            }
        }

        function handleDropInList(event) {
            event.preventDefault();
            const listContainer = document.getElementById('external-events');
            listContainer.classList.remove('drag-enter-list');

            // 1. è™•ç†æ¸…å–®å…§éƒ¨æ’åº
            if (draggedItem) {
                if (placeholder.parentNode) {
                    // å¯¦éš›ç§»å‹•é …ç›®
                    placeholder.parentNode.insertBefore(draggedItem, placeholder);
                }
                
                // æ¸…ç†
                if (placeholder.parentNode) {
                    placeholder.parentNode.removeChild(placeholder);
                }
                draggedItem.style.display = 'block';
                
                // é‡æ–°æ’åº `jobs` é™£åˆ—
                updateJobsOrderFromDOM();

                draggedItem = null;
                placeholder = null;
                return;
            } 
            
            // 2. è™•ç†è¡Œäº‹æ›†äº‹ä»¶æ‹–å›æ¸…å–®
            const eventId = event.dataTransfer.getData('text/event-id');
            if (eventId) {
                const event = calendar.getEventById(eventId);
                if (event) {
                    // åŸ·è¡Œé€€å›æ¸…å–®çš„å‹•ä½œ
                    const job = jobs.find(j => j.id === eventId);
                    if (job) {
                        job.status = 'pending';
                        job.start = null;
                        job.end = null;
                        saveData();
                        event.remove(); // å¾è¡Œäº‹æ›†ç§»é™¤
                        renderList(); // é‡ç¹ªæ¸…å–® (æœƒè‡ªå‹•å°‡ job é¡¯ç¤ºå‡ºä¾†)
                    }
                }
            }
        }
        
        function updateJobsOrderFromDOM() {
            const listContainer = document.getElementById('external-events');
            const items = Array.from(listContainer.querySelectorAll('.draggable-source'));
            
            if (items.length === 0) return;
            
            const newOrderIds = items.map(item => item.dataset.id);
            const originalPendingJobs = jobs.filter(j => j.status === 'pending');
            const scheduledJobs = jobs.filter(j => j.status === 'scheduled');
            
            // æ ¹æ“š DOM é †åºé‡æ–°æ’åº pending jobs
            const reorderedPendingJobs = newOrderIds
                .map(id => originalPendingJobs.find(j => j.id === id))
                .filter(job => job); // éæ¿¾æ‰æ‰¾ä¸åˆ°çš„ (æ‡‰è©²ä¸æœƒç™¼ç”Ÿ)
                
            // åˆä½µä¸¦æ›´æ–° jobs é™£åˆ—
            jobs = [...scheduledJobs, ...reorderedPendingJobs];
            saveData();
        }

        // ==========================================
        // 4. æ ¸å¿ƒåŠŸèƒ½ï¼šå­˜å–è³‡æ–™ (ç¶­æŒä¸è®Š)
        // ==========================================
        function loadData() {
            const json = localStorage.getItem(STORAGE_KEY);
            if (json) {
                jobs = JSON.parse(json);
                // ç¢ºä¿ç‹€æ…‹ç‚º 'pending' çš„æ¡ˆä»¶æ°¸é åœ¨å¾Œï¼Œä»¥ä¾¿æ’åº
                jobs.sort((a, b) => {
                    if (a.status === 'scheduled' && b.status === 'pending') return -1;
                    if (a.status === 'pending' && b.status === 'scheduled') return 1;
                    return 0;
                });
            } else {
                jobs = [];
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
        }
        // ... (çœç•¥ saveTask, deleteTask, clearAllData, loadIntoForm, resetFormï¼Œå…§å®¹èˆ‡ v8 ç›¸åŒ)
        
        function saveTask() {
            const idInput = document.getElementById('input-id');
            const titleInput = document.getElementById('input-title');
            
            const title = titleInput.value.trim();
            const category = document.getElementById('input-category').value;
            const days = document.getElementById('input-days').value;
            const workers = document.getElementById('input-workers').value;
            const note = document.getElementById('input-note').value;
            const color = document.querySelector('input[name="color"]:checked').value;
            const skipSunday = document.getElementById('input-skip-sunday').checked;

            if (!title) {
                alert("âš ï¸ è«‹å‹™å¿…è¼¸å…¥ã€Œæ¡ˆä»¶åç¨±ã€ï¼");
                titleInput.focus();
                return;
            }

            if (idInput.value) {
                // ç·¨è¼¯æ¨¡å¼
                const index = jobs.findIndex(j => j.id === idInput.value);
                if (index !== -1) {
                    jobs[index].title = title;
                    jobs[index].category = category;
                    jobs[index].days = days;
                    jobs[index].workers = workers;
                    jobs[index].note = note;
                    jobs[index].color = color;
                    jobs[index].skipSunday = skipSunday; 

                    if (jobs[index].status === 'scheduled') {
                        let event = calendar.getEventById(jobs[index].id);
                        if (event) {
                            event.setProp('title', title);
                            event.setProp('backgroundColor', color);
                            event.setProp('borderColor', color);
                            
                            if (event.startStr) {
                                const newEnd = calculateEndDate(event.startStr, parseFloat(days), skipSunday);
                                event.setEnd(newEnd);
                                jobs[index].end = newEnd;
                            }
                            
                            event.setExtendedProp('workers', workers);
                            event.setExtendedProp('note', note);
                            event.setExtendedProp('days', days);
                            event.setExtendedProp('skipSunday', skipSunday);
                        }
                    }
                }
                resetForm();
            } else {
                // æ–°å¢æ¨¡å¼
                const newJob = {
                    id: 'job_' + Date.now(),
                    title: title,
                    category: category,
                    days: days,
                    workers: workers,
                    note: note,
                    color: color,
                    status: 'pending',
                    skipSunday: skipSunday, 
                    start: null,
                    end: null
                };
                jobs.push(newJob);
            }

            saveData();
            renderList();
            
            if (!idInput.value) {
                titleInput.value = '';
                titleInput.focus();
            }
        }
        
        function deleteTask(id) {
            if (confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å€‹æ¡ˆä»¶å—ï¼Ÿ")) {
                jobs = jobs.filter(j => j.id !== id);
                let event = calendar.getEventById(id);
                if (event) event.remove();
                
                saveData();
                renderList();
                if(document.getElementById('input-id').value === id) resetForm();
            }
        }

        function clearAllData() {
            if(confirm("âš ï¸ è­¦å‘Šï¼šé€™æœƒæ¸…ç©ºæ‰€æœ‰è³‡æ–™ã€‚ç¢ºå®šå—ï¼Ÿ")) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem('countdown_target_date'); 
                location.reload();
            }
        }

        function loadIntoForm(id) {
            const job = jobs.find(j => j.id === id);
            if (!job) return;

            document.getElementById('input-id').value = job.id;
            document.getElementById('input-title').value = job.title;
            document.getElementById('input-category').value = job.category;
            document.getElementById('input-days').value = job.days;
            document.getElementById('input-workers').value = job.workers;
            document.getElementById('input-note').value = job.note || '';
            document.getElementById('input-skip-sunday').checked = job.skipSunday || false; 
            
            const colorRadio = document.querySelector(`input[name="color"][value="${job.color}"]`);
            if(colorRadio) colorRadio.checked = true;

            document.getElementById('form-container').classList.add('editing-mode');
            document.getElementById('form-title').innerHTML = `<span class="text-orange-600">âœï¸ ç·¨è¼¯ä¸­...</span>`;
            document.getElementById('submit-btn').innerHTML = `<span>ğŸ’¾ ç¢ºèªä¿®æ”¹</span>`;
            document.getElementById('submit-btn').className = "w-full bg-orange-500 hover:bg-orange-600 text-white py-2.5 rounded-lg text-sm font-bold transition shadow-md";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('input-title').focus();
        }

        function resetForm() {
            document.getElementById('input-id').value = '';
            document.getElementById('input-title').value = '';
            document.getElementById('input-note').value = '';
            document.getElementById('input-skip-sunday').checked = false; 
            
            document.getElementById('form-container').classList.remove('editing-mode');
            document.getElementById('form-title').innerHTML = `âœï¸ æ–°å¢æ¡ˆä»¶è³‡æ–™`;
            document.getElementById('submit-btn').innerHTML = `<span>â• åŠ å…¥æ¸…å–®</span>`;
            document.getElementById('submit-btn').className = "w-full bg-slate-800 hover:bg-slate-700 text-white py-2.5 rounded-lg text-sm font-bold transition shadow-md";
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        // ==========================================
        // 5. ä»‹é¢åŠŸèƒ½ï¼šæ¸…å–®æ¸²æŸ“ (åŠ å…¥æ‹–æ›³äº‹ä»¶)
        // ==========================================
        function renderList() {
            const container = document.getElementById('external-events');
            const filterVal = document.getElementById('filter-category').value;
            
            container.innerHTML = ''; // æ¸…ç©º DOM

            const filteredJobs = jobs.filter(j => {
                const isPending = j.status === 'pending';
                const isMatchFilter = filterVal === 'all' || j.category === filterVal;
                return isPending && isMatchFilter;
            });

            if (filteredJobs.length === 0) {
                container.innerHTML = `<div class="text-center mt-8 text-gray-400 text-xs">
                    <p>æ²’æœ‰å¾…æ’ç¨‹æ¡ˆä»¶</p>
                    <p class="mt-1">è«‹åœ¨ä¸Šæ–¹æ–°å¢ ğŸ‘†</p>
                </div>`;
            } else {
                filteredJobs.forEach(job => {
                    const el = document.createElement('div');
                    el.className = 'draggable-source bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-3 group relative';
                    el.style.borderLeftColor = job.color;
                    el.dataset.id = job.id; // é‡è¦ï¼šç¶å®š ID
                    
                    // æ–°å¢æ‹–æ›³äº‹ä»¶å±¬æ€§
                    el.setAttribute('draggable', true);
                    el.addEventListener('dragstart', handleDragStart);
                    el.addEventListener('dragend', () => { 
                        if (placeholder && placeholder.parentNode) {
                            placeholder.parentNode.removeChild(placeholder);
                        }
                        if (draggedItem) draggedItem.style.display = 'block';
                        draggedItem = null;
                        placeholder = null;
                    });
                    
                    let badgeColor = 'bg-gray-100 text-gray-600';
                    if(job.category === 'å¯å®‰æ’') badgeColor = 'bg-blue-50 text-blue-600 border border-blue-100';
                    else if(job.category === 'ç­‰å¾…ç¾å ´') badgeColor = 'bg-yellow-50 text-yellow-600 border border-yellow-100';
                    else if(job.category === 'äº‹å…ˆæ‹†é™¤') badgeColor = 'bg-red-50 text-red-600 border border-red-100';
                    
                    const skipSunIcon = job.skipSunday ? 
                        `<span class="text-[10px] px-1 py-0.5 rounded bg-orange-100 text-orange-600" title="æ’ç¨‹è·³éé€±æ—¥">è·³éé€±æ—¥</span>` : 
                        '';

                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="w-full pr-6 cursor-pointer" onclick="loadIntoForm('${job.id}')" title="é»æ“Šå¯ç·¨è¼¯">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] px-1.5 py-0.5 rounded ${badgeColor}">${job.category}</span>
                                    ${skipSunIcon}
                                </div>
                                <div class="font-bold text-slate-800 text-sm leading-tight mb-1">${job.title}</div>
                                <div class="text-xs text-slate-500 flex gap-3">
                                    <span class="flex items-center">â³ ${job.days}å¤©</span>
                                    <span class="flex items-center">ğŸ‘· ${job.workers}äºº</span>
                                </div>
                                ${job.note ? `<div class="text-[10px] text-gray-400 mt-1 border-t pt-1 truncate">ğŸ“ ${job.note}</div>` : ''}
                            </div>
                            <button onclick="event.stopPropagation(); deleteTask('${job.id}')" 
                                    class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 rounded hover:bg-red-50 transition">
                                âœ•
                            </button>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }
        }


        // ==========================================
        // 6. å€’æ•¸è¨ˆæ™‚åŠŸèƒ½ (ç¶­æŒä¸è®Š)
        // ==========================================
        function updateCountdown() {
            const targetDateStr = document.getElementById('countdown-target-date').value;
            const excludeSunday = document.getElementById('exclude-sun-toggle').checked;
            
            if (!targetDateStr) {
                document.getElementById('countdown-days').innerText = "?";
                localStorage.removeItem('countdown_target_date');
                return;
            }
            
            localStorage.setItem('countdown_target_date', targetDateStr);

            const targetDate = new Date(targetDateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let workDays = 0;
            let tempDate = new Date(today);
            tempDate.setDate(tempDate.getDate() + 1); 

            if (today >= targetDate) {
                document.getElementById('countdown-days').innerText = "0";
                return;
            }
            
            while (tempDate.getTime() < targetDate.getTime()) {
                const dayOfWeek = tempDate.getDay(); 
                
                if (dayOfWeek !== 0 || !excludeSunday) {
                    workDays++;
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }
            
            document.getElementById('countdown-days').innerText = workDays;
        }


        // ==========================================
        // 7. æ’ç¨‹å¤©æ•¸è¨ˆç®—æ ¸å¿ƒå·¥å…· (ç¶­æŒä¸è®Š)
        // ==========================================
        function calculateEndDate(startDateStr, durationDays, skipSunday) {
            let currentDate = new Date(startDateStr + 'T00:00:00');
            let daysRemaining = durationDays;
            
            while (daysRemaining > 0) {
                currentDate.setDate(currentDate.getDate() + 1); 
                
                const dayOfWeek = currentDate.getDay(); 
                
                if (skipSunday && dayOfWeek === 0) {
                    // è·³éé€±æ—¥
                } else {
                    // è¨ˆå…¥ä¸€å¤©
                    daysRemaining--;
                }
            }
            
            return currentDate.toISOString().split('T')[0]; // exclusive end date
        }


        // ==========================================
        // 8. FullCalendar è¨­å®š (å•Ÿç”¨æ‹–å‡ºåŠŸèƒ½)
        // ==========================================
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            const initialEvents = jobs
                .filter(j => j.status === 'scheduled')
                .map(j => ({
                    id: j.id,
                    title: j.title,
                    start: j.start,
                    end: j.end,
                    allDay: true,
                    backgroundColor: j.color,
                    borderColor: j.color,
                    extendedProps: {
                        workers: j.workers,
                        note: j.note,
                        category: j.category,
                        days: j.days,
                        skipSunday: j.skipSunday
                    }
                }));

            calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                editable: true,
                droppable: true,
                height: '100%',
                events: initialEvents,
                
                // å…è¨±æ‹–æ›³åˆ°è¡Œäº‹æ›†å¤– (æ‹–å›æ¸…å–®)
                eventDidMount: function(info) {
                    info.el.setAttribute('draggable', true);
                    info.el.addEventListener('dragstart', function(e) {
                        e.stopPropagation();
                        e.dataTransfer.setData('text/event-id', info.event.id);
                        e.dataTransfer.effectAllowed = 'move';
                    });
                },
                
                // è™•ç†æ‹–æ›³æ¥æ”¶ (æ‰‹å‹•è¨ˆç®—çµæŸæ—¥æœŸ)
                eventReceive: function(info) {
                    const id = info.event.id;
                    const job = jobs.find(j => j.id === id);
                    
                    if (job) {
                        const days = parseFloat(info.event.extendedProps.days);
                        const skipSunday = info.event.extendedProps.skipSunday;
                        const newEnd = calculateEndDate(info.event.startStr, days, skipSunday);
                        
                        info.event.setEnd(newEnd);

                        job.status = 'scheduled';
                        job.start = info.event.startStr;
                        job.end = newEnd; 
                        saveData();

                        if (info.draggedEl && info.draggedEl.parentNode) {
                            info.draggedEl.parentNode.removeChild(info.draggedEl);
                        }
                        renderList(); 
                    } else {
                        info.event.remove();
                    }
                },

                // è™•ç†è¡Œäº‹æ›†ä¸Šæ‹–æ›³ç§»å‹•æˆ–èª¿æ•´å¤§å°
                eventChange: function(info) {
                    const id = info.event.id;
                    const job = jobs.find(j => j.id === id);
                    if (job) {
                        job.start = info.event.startStr;
                        job.end = info.event.endStr;
                        saveData();
                    }
                },

                eventClick: function(info) {
                    const job = jobs.find(j => j.id === info.event.id);
                    const skipSunStatus = job.skipSunday ? 'âœ… (æ’ç¨‹å¤©æ•¸è‡ªå‹•è·³éé€±æ—¥)' : 'âŒ (æ’ç¨‹å¤©æ•¸åŒ…å«é€±æ—¥)';

                    const action = prompt(
                        `ã€${info.event.title}ã€‘\n----------------\nå‚™è¨»ï¼š${info.event.extendedProps.note || 'ç„¡'}\nè·³éé€±æ—¥: ${skipSunStatus}\n\nè«‹é¸æ“‡å‹•ä½œï¼š\n1. âª é€€å›å¾…è¾¦æ¸…å–®\n2. ğŸ—‘ï¸ æ°¸ä¹…åˆªé™¤`, 
                        "1"
                    );
                    
                    if (action === '1') {
                        if (job) {
                            job.status = 'pending';
                            job.start = null;
                            job.end = null;
                            saveData();
                            info.event.remove();
                            renderList();
                        }
                    } else if (action === '2') {
                        deleteTask(info.event.id);
                    }
                },

                eventContent: function(arg) {
                    const workers = arg.event.extendedProps.workers || '?';
                    
                    let dayCount = 1;
                    if (arg.event.end && arg.event.start) {
                        dayCount = (arg.event.end - arg.event.start) / (1000 * 60 * 60 * 24);
                        dayCount = Math.round(dayCount * 10) / 10;
                    }

                    const isSkipping = arg.event.extendedProps.skipSunday;
                    const skipSunBadge = isSkipping ? `<span class="text-[8px] bg-white text-orange-500 rounded-sm px-1 leading-none">è·³æ—¥</span>` : '';

                    return { 
                        html: `
                        <div class="px-1 py-0.5 text-xs overflow-hidden leading-tight">
                             <div class="font-bold truncate text-shadow flex items-center gap-1">
                                ${arg.event.title}
                                ${skipSunBadge}
                             </div>
                             <div class="flex justify-between opacity-90 mt-0.5 text-[10px]">
                                <span>ğŸ‘·${workers}</span>
                                <span>â³${dayCount}</span>
                             </div>
                        </div>` 
                    }
                }
            });
            calendar.render();
        }
    </script>
</body>
</html>
