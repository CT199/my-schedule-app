<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ’å–®ç®¡ç†ç³»çµ± V40 (ä¿®å¾©é€±æ—¥æ’é™¤èˆ‡å·¥æœŸ)</title>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<style>
  /* --- 1. å…¨å±€è¨­å®š (Google Font é¢¨æ ¼) --- */
  :root {
    --bg-color: #f4f6f9;
    --sidebar-width: 320px;
    --primary-color: #1a73e8; /* Google Blue */
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: "Roboto", "Helvetica", "Arial", sans-serif; display: flex; height: 100vh; background: var(--bg-color); overflow: hidden; font-size: 14px; }
  
  /* å·¦å´æ¬„ */
  #sidebar {
    width: var(--sidebar-width); background: white; border-right: 1px solid #dadce0; display: flex;
    flex-direction: column; padding: 16px; z-index: 2000; 
    flex-shrink: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    position: relative; height: 100%; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
  }
  
  /* å³å´è¡Œäº‹æ›†å€ */
  #calendar-wrap { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; background: white;}
  #calendar { flex: 1; padding: 12px; overflow: hidden; }

  /* é›²ç«¯ç‹€æ…‹ç‡ˆ */
  #cloud-status { font-size: 12px; font-weight: 500; padding: 2px 8px; border-radius: 12px; background: #f1f3f4; color: #5f6368; float:right;}

  /* --- 2. ä»‹é¢å…ƒä»¶ (Material Design é¢¨æ ¼) --- */
  h2 { margin: 0 0 16px 0; font-size: 18px; color: #202124; font-weight: 400; display: flex; justify-content: space-between; align-items: center;}
  
  .form-box { background: #fff; padding: 0; margin-bottom: 16px; }
  .input-row { margin-bottom: 10px; }
  
  /* è¼¸å…¥æ¡†å„ªåŒ– */
  input, select { 
    width: 100%; padding: 8px 10px; border: 1px solid #dadce0; border-radius: 4px; 
    font-size: 14px; color: #3c4043; transition: 0.2s; outline: none; height: 36px;
  }
  input:focus, select:focus { border-color: var(--primary-color); border-width: 2px; padding: 7px 9px; }
  
  .labeled-input { display: flex; align-items: center; border: 1px solid #dadce0; border-radius: 4px; overflow: hidden; height: 36px;}
  .labeled-input span { background: #f1f3f4; padding: 0 10px; font-size: 12px; color: #5f6368; font-weight: 500; line-height: 34px; border-right: 1px solid #dadce0; white-space: nowrap;}
  .labeled-input input { border: none; padding: 0 10px; width: 100%; height: 100%; }
  .labeled-input input:focus { border: none; padding: 0 10px; }

  /* é¡è‰²é¸æ“‡å™¨ */
  .color-row { display: flex; gap: 10px; justify-content: flex-start; margin-bottom: 12px; padding: 0 2px;}
  .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 1px #dadce0; transition: transform 0.1s;}
  .color-dot.active { transform: scale(1.2); box-shadow: 0 0 0 2px #3c4043; border-color: white;}

  /* æŒ‰éˆ•å„ªåŒ– */
  button.btn-main { 
    width: 100%; background: var(--primary-color); color: white; border: none; 
    padding: 0 24px; height: 36px; border-radius: 4px; cursor: pointer; 
    font-weight: 500; font-size: 14px; letter-spacing: 0.25px;
    box-shadow: 0 1px 2px rgba(60,64,67,0.3); transition: background 0.2s;
  }
  button.btn-main:hover { background: #1765cc; box-shadow: 0 1px 3px rgba(60,64,67,0.4); }
  .btn-group { display: flex; gap: 8px; margin-top: 12px; }

  .filter-select { margin-bottom: 12px; background-color: #fef7e0; border: 1px solid #fce8b2; color: #b06000; font-weight: 500;}
  
  /* --- 3. å¾…è¾¦æ¸…å–®æ¨£å¼ (Card Style) --- */
  #external-events { flex: 1; overflow-y: auto; padding: 2px; padding-bottom: 60px; }
  
  .pending-card { 
    background: white; border: 1px solid #dadce0; border-radius: 8px; 
    margin-bottom: 8px; position: relative; cursor: pointer;
    box-shadow: 0 1px 2px rgba(60,64,67,0.1); transition: box-shadow 0.2s;
    display: flex; overflow: hidden; min-height: 50px;
  }
  .pending-card:hover { box-shadow: 0 4px 8px rgba(60,64,67,0.15); }
  
  .card-handle {
      width: 24px; background: #f8f9fa; border-right: 1px solid #eee;
      display: flex; align-items: center; justify-content: center;
      color: #bdc1c6; cursor: move; font-size: 14px; flex-shrink: 0;
  }
  .card-content { flex: 1; padding: 8px 10px; overflow: hidden; }
  .card-title { font-weight: 600; color: #3c4043; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-meta { display: flex; gap: 8px; font-size: 11px; color: #70757a; align-items: center;}
  .card-tag { padding: 1px 4px; border-radius: 4px; background: #f1f3f4; color: #5f6368; font-weight: 500;}
  
  .del-btn-card { position: absolute; top: 4px; right: 4px; padding: 4px; color: #dadce0; cursor: pointer; font-size: 16px; line-height: 1; }
  .del-btn-card:hover { color: #d93025; }

  /* --- 4. è¡Œäº‹æ›†å…§äº‹ä»¶æ¨£å¼ (Google Calendar Style) --- */
  .fc-h-event { border: none !important; background: transparent !important; }
  .fc-event-main { padding: 0 !important; }
  
  .google-event {
    width: 100%; height: 100%; padding: 1px 4px; border-radius: 4px;
    display: flex; align-items: center; overflow: hidden; font-family: "Roboto", sans-serif;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
  }
  .g-title {
    font-weight: 700; font-size: 12.5px; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; flex: 1; min-width: 0; line-height: 1.4;
  }
  .g-meta { font-size: 11px; opacity: 0.9; margin-left: 4px; white-space: nowrap; flex-shrink: 0; font-weight: 400; }

  /* --- ä¿®æ­£ï¼šé ‚éƒ¨é¢æ¿ (å›ºå®šä½ç½®) --- */
  #top-panel { 
    display: flex; align-items: center; gap: 10px; 
    background: white; padding: 10px 16px; 
    border-bottom: 1px solid #dadce0;
    flex-shrink: 0; justify-content: flex-start;
  }
  .countdown-wrap { display: flex; align-items: center; gap: 8px; background: #f1f3f4; padding: 4px 12px; border-radius: 18px; }
  #countdown_date { border:none; color: #5f6368; font-family: inherit; cursor: pointer; background: transparent; height: auto; padding: 0;}
  #countdown_output { font-weight: 600; color: var(--primary-color); }

  /* FullCalendar Header å„ªåŒ– */
  .fc-toolbar-title { font-size: 20px !important; color: #3c4043; }
  .fc-button-primary { background-color: white !important; color: #5f6368 !important; border: 1px solid #dadce0 !important; font-weight: 500 !important; text-transform: capitalize !important; box-shadow: none !important;}
  .fc-button-primary:hover { background-color: #f1f3f4 !important; color: #202124 !important; }
  .fc-button-active { background-color: #e8f0fe !important; color: var(--primary-color) !important; border-color: transparent !important;}
  .fc-col-header-cell-c a { color: #70757a; font-weight: 500; font-size: 11px; text-transform: uppercase; padding-top: 8px;}
  .fc-daygrid-day-number { color: #3c4043; font-size: 12px; padding: 4px 8px; }
  .fc-day-today { background-color: transparent !important; }
  .fc-day-today .fc-daygrid-day-number { background-color: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display:flex; align-items:center; justify-content:center; margin: 4px;}

  /* æµ®å‹•æŒ‰éˆ• (FAB) */
  #fab {
      display: none; 
      position: fixed; bottom: 24px; right: 24px; z-index: 2100;
      width: 56px; height: 56px; border-radius: 16px; background: white;
      color: var(--primary-color); border: none; font-size: 30px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.2); cursor: pointer;
      align-items: center; justify-content: center;
      transition: transform 0.2s;
  }
  #fab:active { transform: scale(0.95); }

  /* æ‰‹æ©Ÿé®ç½©å±¤ */
  #mobile-overlay {
      display: none; position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.4); z-index: 1900; opacity: 0; transition: opacity 0.3s;
      backdrop-filter: blur(2px);
  }
  #mobile-overlay.visible { opacity: 1; }

  /* é»æ“Šæ’å–®æç¤º */
  #date-click-hint {
      margin-top: 0px; margin-bottom: 12px; padding: 10px; border-radius: 8px; 
      background: #e8f0fe; color: var(--primary-color); font-weight: 500; font-size: 14px; 
      border: 1px dashed var(--primary-color); cursor: pointer; text-align: center;
  }

  /* --- RWD æ‰‹æ©Ÿç‰ˆå„ªåŒ– --- */
  @media (max-width: 768px) {
    body { flex-direction: column; }
    
    #sidebar { 
        position: absolute; top: 0; left: 0; 
        width: 85%; max-width: 300px; height: 100%; 
        transform: translateX(-100%); 
        box-shadow: 4px 0 15px rgba(0,0,0,0.2);
    }
    #sidebar.open { transform: translateX(0); }

    #calendar-wrap { padding: 0; height: 100%; }
    #calendar { padding: 0; }
    
    .fc-header-toolbar { padding: 8px 10px; margin-bottom: 0 !important; }
    .fc-toolbar-title { font-size: 18px !important; }
    
    #fab { display: flex; }
    
    /* æ‰‹æ©Ÿç‰ˆé ‚éƒ¨é¢æ¿ */
    #top-panel { padding: 8px 10px; justify-content: center; border-bottom: 1px solid #eee; }

    /* æ‰‹æ©Ÿç‰ˆäº‹ä»¶é¡¯ç¤ºå„ªåŒ– */
    .google-event { padding: 1px 3px; min-height: 18px; }
    .g-title { font-size: 12px; font-weight: 600; }
    .g-meta { display: none; }
   }
</style>
</head>
<body>

<button id="fab" onclick="toggleSidebar()">ï¼‹</button>
<div id="mobile-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
  <h2> æ’å–®ç³»çµ± V40 <span id="cloud-status">é€£ç·šä¸­...</span></h2>

  <div id="date-click-hint" style="display:none;" onclick="cancelDirectSchedule()"></div>

  <div id="add-box" class="form-box">
    <div class="input-row"><input id="t_title" class="enter-submit" type="text" placeholder="è¼¸å…¥æ¡ˆå"></div>
    <div class="input-row">
      <select id="t_cat" class="enter-submit">
        <option value="å¯å®‰æ’">å¯å®‰æ’</option>
        <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
        <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
        <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
      </select>
    </div>
    <div class="input-row"><input id="t_note" class="enter-submit" type="text" placeholder="å‚™è¨» (é¸å¡«)"></div>
    <div class="input-row" style="display:flex; gap:8px;">
      <div class="labeled-input" style="flex:1"><span>å¤©æ•¸</span><input id="t_days" class="enter-submit" type="number" min="1" value="1"></div>
      <div class="labeled-input" style="flex:1"><span>äººæ•¸</span><input id="t_ppl" class="enter-submit" type="number" min="1" value="1"></div>
    </div>
    <div class="color-row" id="color-row"></div>
    <button class="btn-main" id="btn-add-event" onclick="addEvent()">ï¼‹ æ–°å¢æ¡ˆä»¶ (Enter)</button>
  </div>

  <div id="edit-box" class="form-box" style="display:none; border: 2px solid var(--primary-color); padding: 10px; border-radius: 8px;">
    <div style="color:var(--primary-color); font-weight:bold; margin-bottom:10px;"> ğŸ“ ç·¨è¼¯æ¡ˆä»¶</div>
    <input type="hidden" id="e_id"><input type="hidden" id="e_source"> 
    <div class="input-row"><input id="e_title" type="text"></div>
    <div class="input-row">
      <select id="e_cat">
        <option value="å¯å®‰æ’">å¯å®‰æ’</option>
        <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
        <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
        <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
      </select>
    </div>
    <div class="input-row"><input id="e_note" type="text" placeholder="å‚™è¨»"></div>
    <div class="input-row" style="display:flex; gap:8px;">
      <div class="labeled-input" style="flex:1"><span>å¤©æ•¸</span><input id="e_days" type="number" min="1"></div>
      <div class="labeled-input" style="flex:1"><span>äººæ•¸</span><input id="e_ppl" type="number" min="1"></div>
    </div>
    <div class="color-row" id="edit-color-row"></div>
    <div class="btn-group">
      <button class="btn-main" onclick="confirmUpdate()">ç¢ºèª</button>
      <button class="btn-main" style="background:#f6bf26; color:#3c4043; display:none;" id="btn-move-to-pending" onclick="moveToPendingList()">æ‹‰å›æ¸…å–®</button>
      <button class="btn-main" style="background:#d93025; display:none;" id="btn-del-cal" onclick="deleteFromCalendar()">åˆªé™¤</button>
      <button class="btn-main" style="background:#f1f3f4; color:#3c4043;" onclick="hideEditForm()">å–æ¶ˆ</button>
    </div>
  </div>

  <select id="filter_cat" class="filter-select" onchange="renderPending()">
    <option value="ALL">é¡¯ç¤ºå…¨éƒ¨</option>
    <option value="å¯å®‰æ’">å¯å®‰æ’</option>
    <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
    <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
    <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
  </select>

  <div id="external-events"></div>
</div>

<div id="calendar-wrap">
  <div id="top-panel">
    <div class="countdown-wrap">
      <span style="font-size:12px; color:#5f6368">å€’æ•¸è‡³</span>
      <input type="date" id="countdown_date" onchange="updateCountdown(true)">
      <span id="countdown_output">...</span>
    </div>
  </div>
  <div id="calendar"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIqvMrXiRKl50Z_ZAZtn1UVAqpnnlnVmI",
  authDomain: "project-2936455536954733138.firebaseapp.com",
  projectId: "project-2936455536954733138",
  storageBucket: "project-2936455536954733138.firebasestorage.app",
  messagingSenderId: "248829609752",
  appId: "1:248829609752:web:de5e3882d215514d34406d"
};

let db;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
} catch (e) {
    console.error("Firebase init failed:", e);
    document.getElementById('cloud-status').innerText = "è¨­å®šéŒ¯èª¤";
}

if(db) {
    const statusEl = document.getElementById('cloud-status');
    onSnapshot(doc(db, "sch_system", "data"), (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            statusEl.innerText = "å·²åŒæ­¥"; statusEl.style.color = "#188038";
            
            window.pendingList = data.pending || [];
            window.renderPending();
            
            if(window.calendarAPI) {
                window.calendarAPI.removeAllEvents();
                window.calendarAPI.addEventSource(data.events || []);
            }

            if(data.countdown) {
                document.getElementById('countdown_date').value = data.countdown;
                window.updateCountdown(false); 
            }
        } else { statusEl.innerText = "ç„¡è³‡æ–™"; }
    });
}

let saveTimer = null;
window.saveToCloud = async function() {
    if (!db) return;
    const statusEl = document.getElementById('cloud-status');
    statusEl.innerText = "å„²å­˜ä¸­..."; statusEl.style.color = "#f6bf26";

    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
        const currentPending = window.pendingList || [];
        const currentEvents = window.calendarAPI ? window.calendarAPI.getEvents().map(e => ({
            id: e.id, title: e.title, start: e.startStr, end: e.endStr, allDay: e.allDay,
            backgroundColor: e.backgroundColor, extendedProps: e.extendedProps
        })) : [];
        const currentCountdown = document.getElementById('countdown_date').value;

        try {
            await setDoc(doc(db, "sch_system", "data"), {
                pending: currentPending, events: currentEvents, countdown: currentCountdown, lastUpdate: new Date().toISOString()
            });
            statusEl.innerText = "å·²åŒæ­¥"; statusEl.style.color = "#188038";
        } catch (e) {
            console.error(e); 
            statusEl.innerText = "å¤±æ•—"; statusEl.style.color = "#d93025";
        }
    }, 1000);
};
</script>

<script>
const COLORS = ['#1a73e8', '#188038', '#d93025', '#f6bf26', '#8e24aa', '#e37400']; // Google Colors
let curColor = COLORS[0], editCurColor = COLORS[0]; 
let calendarAPI, sortableInstance;
window.pendingList = []; let editObj = null, editSource = '';
let selectedDate = null;

document.addEventListener('DOMContentLoaded', () => {
    initColors();
    initEnterKey();
    
    let listEl = document.getElementById('external-events');
    sortableInstance = Sortable.create(listEl, {
        animation: 150, 
        ghostClass: 'sortable-ghost', 
        handle: '.card-handle', // åƒ…æ¸…å–®ä½¿ç”¨æŠŠæ‰‹
        onEnd: saveListOrder
    });

    if (!isMobile()) { 
        new FullCalendar.Draggable(listEl, {
            itemSelector: '.pending-card',
            eventData: (el) => {
                let id = el.getAttribute('data-id');
                let item = window.pendingList.find(x => x.id === id);
                return {
                    id: 'evt_' + item.id, title: item.title, backgroundColor: item.color, borderColor: item.color,
                    extendedProps: { sid: item.id, cat: item.cat, note: item.note, days: item.days, ppl: item.ppl }
                };
            }
        });
    }
    
    let calEl = document.getElementById('calendar');
    calendarAPI = new FullCalendar.Calendar(calEl, {
        headerToolbar: { 
            left: 'prev,next today', 
            center: 'title', 
            right: 'dayGridMonth' 
        },
        locale: 'zh-tw', editable: true, droppable: !isMobile(), 
        dayMaxEvents: 4, height: '100%', 
        initialEvents: [], 
        
        dateClick: (info) => {
            selectedDate = info.dateStr; 
            document.getElementById('date-click-hint').innerText = `âœ… é–å®šæ—¥æœŸï¼š${selectedDate} (é»æ“Šå–æ¶ˆ)`;
            document.getElementById('date-click-hint').style.display = 'block';
            document.getElementById('btn-add-event').innerText = `æ’å…¥ ${selectedDate}`;

            document.getElementById('add-box').style.display = 'block';
            document.getElementById('edit-box').style.display = 'none';
            document.getElementById('t_title').focus();
            if(isMobile()) toggleSidebar();
        },
        
        eventReceive: (info) => {
            if(!info.event.id) info.event.setProp('id', 'evt_' + Date.now());
            removePending(info.event.extendedProps.sid); 
            window.saveToCloud();
        },
        eventChange: (info) => window.saveToCloud(),
        eventClick: (info) => openEdit(info.event, 'calendar'),
        eventDragStop: (info) => {
            if (isMobile()) return; 
            let sidebar = document.getElementById('sidebar');
            let rect = sidebar.getBoundingClientRect();
            let x = info.jsEvent.clientX, y = info.jsEvent.clientY;
            
            if (sidebar.offsetParent !== null && x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                if(confirm('é€€å›æ¸…å–®ï¼Ÿ')) {
                    let p = info.event.extendedProps;
                    addPendingItem({
                        id: p.sid || ('p_' + Date.now()), title: info.event.title, 
                        cat: p.cat, note: p.note, days: p.days, ppl: p.ppl, color: info.event.backgroundColor
                    });
                    info.event.remove();
                    window.saveToCloud();
                }
            }
        },
        
        eventContent: (arg) => {
            let p = arg.event.extendedProps;
            let bgColor = arg.event.backgroundColor;
            let textColor = (bgColor === '#f6bf26') ? '#3c4043' : 'white';
            
            let html = `
            <div class="google-event" style="background:${bgColor}; color:${textColor}">
                <div class="g-title">${arg.event.title}</div>
                <div class="g-meta">${p.ppl||1}äºº</div>
            </div>`;
            return { html: html };
        },

        dayCellContent: (arg) => { 
            if (arg.dayNumberText) return { html: `<span class="fc-daygrid-day-number">${arg.dayNumberText.replace('æ—¥', '')}</span>` };
            return arg.domNodes;
        },
        dayHeaderFormat: { weekday: 'short' }
    });
    window.calendarAPI = calendarAPI;
    calendarAPI.render();
});

function isMobile() { return window.matchMedia("(max-width: 768px)").matches; }

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    if (!isMobile()) {  
        sidebar.style.display = (sidebar.style.display === 'none') ? 'flex' : 'none'; 
        setTimeout(() => calendarAPI.updateSize(), 200); 
        return;
    }

    const isOpen = sidebar.classList.contains('open');
    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('visible');
        setTimeout(() => overlay.style.display = 'none', 300);
    } else {
        overlay.style.display = 'block';
        setTimeout(() => {
            sidebar.classList.add('open');
            overlay.classList.add('visible');
        }, 10);
        document.getElementById('add-box').style.display = 'block';
        document.getElementById('edit-box').style.display = 'none';
        if (selectedDate) cancelDirectSchedule(false);
    }
}

window.updateCountdown = function(isWrite = false) {
    if(isWrite && window.saveToCloud) window.saveToCloud();
    let input = document.getElementById('countdown_date');
    let output = document.getElementById('countdown_output');
    if(!input.value) { output.textContent = "--"; return; }
    
    let target = new Date(input.value); target.setHours(0,0,0,0);
    let now = new Date(); now.setHours(0,0,0,0);
    let diff = target.getTime() - now.getTime();
    let d = Math.ceil(diff/86400000);
    
    output.textContent = (diff >= 0) ? `${d}å¤©` : `é${Math.ceil(Math.abs(diff)/86400000)}å¤©`;
}

// â˜…â˜…â˜… V40 æ ¸å¿ƒä¿®å¾©ï¼šæ’é™¤é€±æ—¥ + æ­£ç¢ºè¨ˆç®—å·¥æœŸ (è§£æ±º2å¤©è®Š1å¤©å•é¡Œ) â˜…â˜…â˜…
function calculateEndDate(startDateStr, days) {
    let date = new Date(startDateStr);
    let count = 0;
    
    while (count < days) {
        // å¦‚æœé‡åˆ°é€±æ—¥ (0)ï¼ŒåªåŠ æ—¥æœŸï¼Œä¸åŠ è¨ˆæ•¸ (è·³éé€±æ—¥)
        if (date.getDay() === 0) {
            date.setDate(date.getDate() + 1);
            continue; 
        }
        // å¹³æ—¥/é€±å…­ï¼šåŠ æ—¥æœŸï¼ŒåŠ è¨ˆæ•¸
        date.setDate(date.getDate() + 1);
        count++;
    }
    
    return date.toISOString().split('T')[0];
}

function cancelDirectSchedule(closeSidebar = true) {
    selectedDate = null;
    document.getElementById('date-click-hint').style.display = 'none';
    document.getElementById('btn-add-event').innerText = 'ï¼‹ æ–°å¢æ¡ˆä»¶ (Enter)';
    document.getElementById('t_title').focus();
    if(closeSidebar && isMobile()) toggleSidebar();
}

function schedulePendingItem(item) {
    if (!selectedDate) return; 
    // ä½¿ç”¨ V40 çš„ calculateEndDate ç¢ºä¿è·³éé€±æ—¥
    calendarAPI.addEvent({
        id: 'evt_' + item.id, title: item.title, start: selectedDate,
        end: calculateEndDate(selectedDate, item.days), allDay: true,
        backgroundColor: item.color, borderColor: item.color,
        extendedProps: { sid: item.id, cat: item.cat, note: item.note, days: item.days, ppl: item.ppl }
    });
    removePending(item.id); 
    cancelDirectSchedule(true); 
    window.saveToCloud();
}

function addEvent() {
    let title = document.getElementById('t_title').value.trim();
    if(!title) return alert('è«‹è¼¸å…¥æ¡ˆå');
    
    let days = parseInt(document.getElementById('t_days').value) || 1;
    let eventData = {
        id: 'p_' + Date.now(), title: title,
        cat: document.getElementById('t_cat').value,
        note: document.getElementById('t_note').value,
        days: days,
        ppl: parseInt(document.getElementById('t_ppl').value) || 1,
        color: curColor
    };
    
    if (selectedDate) {
        calendarAPI.addEvent({
            id: 'evt_' + eventData.id, title: eventData.title, start: selectedDate,
            end: calculateEndDate(selectedDate, eventData.days), allDay: true,
            backgroundColor: eventData.color, borderColor: eventData.color,
            extendedProps: { sid: eventData.id, cat: eventData.cat, note: eventData.note, days: eventData.days, ppl: eventData.ppl }
        });
        cancelDirectSchedule(false);
        window.saveToCloud();
    } else {
        addPendingItem(eventData);
    }
    
    document.getElementById('t_title').value = '';
    document.getElementById('t_note').value = '';
    if(isMobile() && !selectedDate) toggleSidebar(); 
}

function addPendingItem(item) {
    window.pendingList.unshift(item); 
    window.saveToCloud(); 
    window.renderPending();
}

function removePending(id) {
    window.pendingList = window.pendingList.filter(x => x.id !== id);
    window.renderPending();
}

function saveListOrder() {
    let listEl = document.getElementById('external-events');
    let newOrderIds = Array.from(listEl.children).map(el => el.getAttribute('data-id'));
    let newList = [];
    newOrderIds.forEach(id => {
        let item = window.pendingList.find(x => x.id === id);
        if(item) newList.push(item);
    });
    let filter = document.getElementById('filter_cat').value;
    if(filter !== 'ALL') {
        let hidden = window.pendingList.filter(x => x.cat !== filter);
        newList = newList.concat(hidden);
    }
    window.pendingList = newList;
    window.saveToCloud();
}

window.renderPending = function() {
    let listEl = document.getElementById('external-events');
    listEl.innerHTML = '';
    let filter = document.getElementById('filter_cat').value;
    
    window.pendingList.forEach(item => {
        if(filter !== 'ALL' && item.cat !== filter) return;
        let div = document.createElement('div');
        div.className = 'pending-card'; div.setAttribute('data-id', item.id); div.style.borderLeft = `4px solid ${item.color}`;
        
        div.onclick = (e) => { 
            if(e.target.classList.contains('del-btn-card') || e.target.classList.contains('card-handle')) return;
            if (selectedDate) schedulePendingItem(item);
            else openEdit(item, 'list'); 
        };
        
        div.innerHTML = `
            <div class="card-handle">â‹®</div>
            <div class="card-content">
                <div class="card-title">${item.title}</div>
                <div class="card-meta">
                    <span class="card-tag">${item.cat}</span> 
                    <span>${item.days}å¤©</span> <span>${item.ppl}äºº</span>
                </div>
            </div>
            <div class="del-btn-card" onclick="event.stopPropagation(); if(confirm('åˆªé™¤?')) { removePending('${item.id}'); window.saveToCloud(); }">Ã—</div>
        `;
        listEl.appendChild(div);
    });
}

function moveToPendingList() {
    if (!editObj || editSource !== 'calendar') return;
    if (confirm('é€€å›æ¸…å–®ï¼Ÿ')) {
        let p = editObj.extendedProps;
        addPendingItem({
            id: p.sid || ('p_' + Date.now()), title: editObj.title, 
            cat: p.cat, note: p.note, days: p.days, ppl: p.ppl, color: editObj.backgroundColor
        });
        editObj.remove();
        window.saveToCloud();
        hideEditForm();
    }
}

function openEdit(obj, source) {
    if(isMobile()) { 
        const sidebar = document.getElementById('sidebar');
        if(!sidebar.classList.contains('open')) toggleSidebar();
    }
    
    if (selectedDate) cancelDirectSchedule(false);

    editObj = obj; editSource = source;
    document.getElementById('add-box').style.display = 'none';
    document.getElementById('edit-box').style.display = 'block';
    
    let isCalendarSource = (source === 'calendar');
    document.getElementById('btn-del-cal').style.display = isCalendarSource ? 'inline-block' : 'none';
    document.getElementById('btn-move-to-pending').style.display = isCalendarSource ? 'inline-block' : 'none'; 
    
    let p = (source === 'calendar') ? obj.extendedProps : obj;
    document.getElementById('e_title').value = (source === 'calendar') ? obj.title : obj.title;
    document.getElementById('e_cat').value = p.cat || 'å¯å®‰æ’';
    document.getElementById('e_note').value = p.note || '';
    document.getElementById('e_days').value = p.days || 1;
    document.getElementById('e_ppl').value = p.ppl || 1;
    let color = (source === 'calendar') ? obj.backgroundColor : obj.color;
    editCurColor = color;
    setupColors('edit-color-row', (c) => editCurColor = c, color);
}

function confirmUpdate() {
    if(!editObj) return;
    let title = document.getElementById('e_title').value;
    let cat = document.getElementById('e_cat').value;
    let note = document.getElementById('e_note').value;
    let days = parseInt(document.getElementById('e_days').value) || 1;
    let ppl = parseInt(document.getElementById('e_ppl').value) || 1;
    
    if(editSource === 'calendar') {
        editObj.setProp('title', title); editObj.setProp('backgroundColor', editCurColor); editObj.setProp('borderColor', editCurColor);
        editObj.setExtendedProp('cat', cat); editObj.setExtendedProp('note', note);
        editObj.setExtendedProp('days', days); editObj.setExtendedProp('ppl', ppl);
        // æ›´æ–°æ™‚ä¹Ÿå¥—ç”¨é€±æ—¥æ’é™¤é‚è¼¯
        if(editObj.start && days >= 1) editObj.setEnd(calculateEndDate(editObj.startStr, days));
        window.saveToCloud();
    } else {
        let item = window.pendingList.find(x => x.id === editObj.id);
        if(item) {
            item.title = title; item.cat = cat; item.note = note;
            item.days = days; item.ppl = ppl; item.color = editCurColor;
            window.saveToCloud(); window.renderPending();
        }
    }
    hideEditForm();
}

function hideEditForm() {
    document.getElementById('add-box').style.display = 'block';
    document.getElementById('edit-box').style.display = 'none';
    editObj = null;
    if(isMobile()) toggleSidebar(); 
}

function deleteFromCalendar() {
    if(confirm('åˆªé™¤ï¼Ÿ')) { editObj.remove(); window.saveToCloud(); hideEditForm(); }
}

function initColors() { setupColors('color-row', (c) => curColor = c, curColor); }
function setupColors(id, callback, defaultColor) {
    let box = document.getElementById(id); box.innerHTML = '';
    COLORS.forEach((c, i) => {
        let d = document.createElement('div');
        d.className = 'color-dot ' + ((defaultColor && sameColor(c, defaultColor)) || (!defaultColor && i===0) ? 'active' : '');
        d.style.backgroundColor = c;
        d.onclick = () => { Array.from(box.children).forEach(x => x.classList.remove('active')); d.classList.add('active'); callback(c); };
        box.appendChild(d);
    });
}
function sameColor(a, b) { return a.toLowerCase() === b.toLowerCase() || rgbToHex(a) === b.toLowerCase(); }
function rgbToHex(rgb) { if(rgb.startsWith('#')) return rgb; return '#000000'; } 
function initEnterKey() { document.querySelectorAll('.enter-submit').forEach(el => { el.onkeypress = (e) => { if(e.key==='Enter') addEvent(); }; }); }
</script>
</body>
</html>
